#!/bin/bash
if [[ -e /dev/sdb ]]; then
  echo "*********************************
***           ERROR           ***
*********************************
Your drives are not set to RAID 1 mode.
Power down your CloudShell 2, adjust the dip switch,
then hold the RAID Setup key for 30 seconds while powering up."
  exit 0
fi

if [[ -e /dev/sda ]]; then
  if [[ -e /dev/sda1 ]]; then
    echo "*********************************
***          WARNING          ***
*********************************
Your disk array already contains partitions / data.

If you proceed, all data on your disk array will be lost.
"
    read -r -p "Do you want to destroy the array and re-initialize? [y/N] " beta
    echo ""
    if [[ $beta =~ ^([yY][eE][sS]|[yY])$ ]]; then
      echo "Proceeding..."
      # Instantly destory all partitions on /dev/sda
      dd if=/dev/zero of=/dev/sda bs=512 count=1 > /dev/null 2>&1
    else
      echo "Aborted."
      exit 1
    fi

  fi
else
  echo "You do not have a RAID 1 configured. Please fix and try again."
  exit 0
fi

# Clear old entries in /etc/fstab
/bin/sed -i~ '/\/mnt\/data/d' /etc/fstab

# Unmount it if mounted
if mount | grep -q "/mnt/data"; then
  umount /mnt/data
fi

# Create /dev/sda1 partition using entire size of array
echo 'type=83' | sfdisk /dev/sda > /dev/null 2>&1

# Create filesystem on /dev/sda1
yes | mkfs.ext3 /dev/sda1

# Get the UUID of /dev/sda1
uuid=$(blkid -s UUID -o value /dev/sda1)

# Create the mountpoint
if [[ ! -e /mnt/data ]]; then
  mkdir /mnt/data
else
  if mount | grep -q "/mnt/data"; then
    umount /mnt/data
  fi
fi

# Make /mnt/data immutable
chattr +i /mnt/data

# Create fstab entry
echo "UUID=$uuid	/mnt/data	ext3	errors=remount-ro,noatime,discard	0	1" >> /etc/fstab

# Set spindown delay and make persistent
echo "## Configuration created by Nebulinux drive-prep command.
## If you modify settings here and then run drive-prep, you will lose your settings.

quiet

/dev/sda {
  ## 0 disable spindown
  ## 1 to 240 = 5 second increments
  ## 241 to 251 30 minutes increments
  #  Nebulinux default is 242 / 1 hour
  spindown_time = 242
}
" > /etc/hdparm.conf

# Mount it
mount -a

if mount | grep -q "/mnt/data"; then
  chown -R www-data:www-data /mnt/data
  echo "Success! /mnt/data is now setup for your Array. Use this when activating NextCloud."
else
  # Delete the failed entry from /etc/fstab
  /bin/sed -i~ '/\/mnt\/data/d' /etc/fstab
  echo "Failure!"
fi

